<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>How to use Port Knocking to hide your SSH Daemon on centos 7 | wymhuster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1.How Does Port Knocking Work?Port knocking works by configuring a service to watch firewall logs or packet capture interfaces for connection attempts. If a specific sequence of predefined connection">
<meta property="og:type" content="article">
<meta property="og:title" content="How to use Port Knocking to hide your SSH Daemon on centos 7">
<meta property="og:url" content="http://yoursite.com/2016/06/04/how-to-use-port-knocking-on-centos-7/index.html">
<meta property="og:site_name" content="wymhuster">
<meta property="og:description" content="1.How Does Port Knocking Work?Port knocking works by configuring a service to watch firewall logs or packet capture interfaces for connection attempts. If a specific sequence of predefined connection">
<meta property="og:updated_time" content="2016-06-08T01:16:43.791Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How to use Port Knocking to hide your SSH Daemon on centos 7">
<meta name="twitter:description" content="1.How Does Port Knocking Work?Port knocking works by configuring a service to watch firewall logs or packet capture interfaces for connection attempts. If a specific sequence of predefined connection">
  
    <link rel="alternative" href="/atom.xml" title="wymhuster" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
<form class="search" method="get" accept-charset="utf-8">
<label>Search</label>
			<input type="text" id="19940428" class="st-search-input_my" maxlength="10" placeholder="search" />
		</form>
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://o8ablah0u.bkt.clouddn.com/IMG_1838%20%281%29.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">wymhuster</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">失业中</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">wymhuster</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://o8ablah0u.bkt.clouddn.com/IMG_1838%20%281%29.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">wymhuster</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-how-to-use-port-knocking-on-centos-7" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/04/how-to-use-port-knocking-on-centos-7/" class="article-date">
  	<time datetime="2016-06-04T09:46:16.000Z" itemprop="datePublished">2016-06-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      How to use Port Knocking to hide your SSH Daemon on centos 7
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-How-Does-Port-Knocking-Work"><a href="#1-How-Does-Port-Knocking-Work" class="headerlink" title="1.How Does Port Knocking Work?"></a>1.How Does Port Knocking Work?</h2><p>Port knocking works by configuring a service to watch firewall logs or packet capture interfaces for connection attempts. If a specific sequence of predefined connection attempts (or “knocks”) are made, the service will modify the firewall rules to open up connections on a certain port.</p>
<p>This allows you to keep your services hidden until you actually plan on using them. This would not be practical for something like an HTTP server because you would want connections available at all time. But it would be useful for services meant to be used only by known, legitimate users, like SSH.</p>
<p>Although a knocking sequence can be arbitrarily complex, it is not, in and of itself, usually the only set of security measures. Usually the service’s own security and authentication methods are then exposed to a user who issues the correct sequence. In this way, port knocking adds an additional layer that a user must go through to even get to the regular authentication.</p>
<p>Even more helpful is that there is no feedback given on knocking attempts. An intruder scanning would see all of the usual ports closed and if they attempted a knocking sequence, would have to check between each attempt to see if a port was opened. This is often enough to dissuade or prohibit attackers.</p>
<p>For our purposes, we will be using the iptables firewall that comes with Centos 7, and installing a daemon called knockd to provide the port knocking functionality.</p>
<h2 id="2-Install-knockd-on-centos-7"><a href="#2-Install-knockd-on-centos-7" class="headerlink" title="2.Install  knockd on centos 7"></a>2.Install  knockd on centos 7</h2><p>At first ,you should down the rpm packages of knockd through wget<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.invoca.ch/pub/packages/knock/RPMS/ils-7/SRPMS/knock-0.7-1.el7.src.rpm</span><br></pre></td></tr></table></figure></p>
<p>the download url of SRPM :<a href="http://www.invoca.ch/pub/packages/knock/" target="_blank" rel="external">http://www.invoca.ch/pub/packages/knock/</a></p>
<p>rpmbuild the *.src.rpm files</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpmbuild --rebuild knock-0.7-1.e17.src.rpm</span><br></pre></td></tr></table></figure>
<p>rpm install the rpm files after rebuild the src.rpm files</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh /the/path/of/rebuild/files</span><br></pre></td></tr></table></figure>
<h2 id="3-PAY-ATTENTION"><a href="#3-PAY-ATTENTION" class="headerlink" title="3.PAY ATTENTION"></a>3.PAY ATTENTION</h2><p>when you begin to use knockd ,you should start your iptables service firstly.But on centos 7, firewalld was introduced to manage iptables. IMHO, firewalld is more suited for workstations than for server environments.It is possible to go back to a more classic iptables setup. First, stop and mask the firewalld service:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl mask firewalld</span><br></pre></td></tr></table></figure></p>
<p>Then,install iptables-service packages<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables-services</span><br></pre></td></tr></table></figure></p>
<p>Enable the service at boot-time<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> iptables</span><br></pre></td></tr></table></figure></p>
<p>Magnaging the service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl [stop|start|restart] iptables</span><br></pre></td></tr></table></figure></p>
<p>Saving the firewall rules can be down as follows<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br></pre></td></tr></table></figure></p>
<h2 id="4-Configure-IPTables-to-Block-Most-Traffic"><a href="#4-Configure-IPTables-to-Block-Most-Traffic" class="headerlink" title="4.Configure IPTables to Block Most Traffic"></a>4.Configure IPTables to Block Most Traffic</h2><p>Begin by allowing traffic on the local machine. This means accepting traffic that the server generates and sends to itself. This allows services to talk to each other without being blocked:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>Next, we want to make sure we allow all established connections and traffic related to established connections by typing:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>And ,accept the port 80 to run the web service .<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>Now, we will drop everything we haven’t specifically allowed. Add this rule:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -j DROP</span><br></pre></td></tr></table></figure></p>
<p>Any traffic that hasn’t been handled by the above rules will be dropped. You can view your rules by typing:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -S</span><br></pre></td></tr></table></figure></p>
<p>You will see the below<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line">-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">-A INPUT -j DROP</span><br></pre></td></tr></table></figure></p>
<h2 id="5-Make-the-iptables-persistent-after-reboot"><a href="#5-Make-the-iptables-persistent-after-reboot" class="headerlink" title="5.Make the iptables persistent after reboot"></a>5.Make the iptables persistent after reboot</h2><p>the iptables will be lost after you rebuild your server.In order to persistent the iptables ,vim /etc/sysconfig/iptables-config<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES_SAVE_ON_STOP=<span class="string">"no"</span></span><br><span class="line">IPTABLES_SAVE_ON_RESTART=<span class="string">"no"</span></span><br></pre></td></tr></table></figure></p>
<p>set IPTABLES_SAVE_ON_STOP=”no” to “yes”<br>set IPTABLES_SAVE_ON_RESTART=”no” to “yes”</p>
<font size="5" color="red">Do’t do this step until you make sure that your iptables is set correctlly</font>

<h2 id="6-Configure-Knockd-to-Use-Port-Knocking"><a href="#6-Configure-Knockd-to-Use-Port-Knocking" class="headerlink" title="6.Configure Knockd to Use Port Knocking"></a>6.Configure Knockd to Use Port Knocking</h2><p>To configure the service, we will have to edit the configuration file. Open this file with root privileges:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/knockd.conf</span><br></pre></td></tr></table></figure>
<p>You will see the below<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[options]</span><br><span class="line">    UseSyslog</span><br><span class="line">[opencloseSSH]</span><br><span class="line">    sequence      = 2222:udp,3333:tcp,4444:udp</span><br><span class="line">    seq_timeout   = 15</span><br><span class="line">    tcpflags      = syn,ack</span><br><span class="line">    start_<span class="built_in">command</span> = /sbin/iptables -A INPUT <span class="_">-s</span> %IP% -p tcp --dport ssh -j ACCEPT</span><br><span class="line">    cmd_timeout   = 10</span><br><span class="line">    stop_<span class="built_in">command</span>  = /sbin/iptables -D INPUT <span class="_">-s</span> %IP% -p tcp --dport ssh -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>The result is that when the correct sequence is used, the daemon will open the SSH port. It will then wait 10 seconds and then close the port again.Implement your new rule by restarting the daemon:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo service knockd restart</span><br><span class="line">sudo chkconfig knockd on</span><br></pre></td></tr></table></figure></p>
<h2 id="7-Now-knock-the-door"><a href="#7-Now-knock-the-door" class="headerlink" title="7.Now knock the door!"></a>7.Now knock the door!</h2><p>THE OS is windows 10,and I’m using the knock client to knock the server.<br>THE url to download client :<a href="http://www.zeroflux.org/proj/knock/files/knock-win32.zip" target="_blank" rel="external">http://www.zeroflux.org/proj/knock/files/knock-win32.zip</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">knock -v 192.168.1.254 2100:tcp 2200:udp 2300:tcp</span><br></pre></td></tr></table></figure></p>
<p>And you will find you can enter your server through ssh</p>

      
    </div>
    
  </div>
  
    
  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="how-to-use-port-knocking-on-centos-7" data-title="How to use Port Knocking to hide your SSH Daemon on centos 7" data-url="http://yoursite.com/2016/06/04/how-to-use-port-knocking-on-centos-7/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"wymhuster"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 wymhuster
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
    <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','bgPZswnFC5YQTKMKbSFN','2.0.0');
</script>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>